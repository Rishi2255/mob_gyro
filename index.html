<!DOCTYPE html>
<html>
<head>
    <title>360 VR - SBS Wrap Fixed</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #ui { 
            position: absolute; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #000; color: white; font-family: sans-serif;
        }
        button { 
            padding: 20px 40px; background: #222; color: white; border: 1px solid #444; 
            border-radius: 8px; font-size: 18px; cursor: pointer;
        }
        .hidden { display: none !important; }
        /* Hide A-Frame's default UI */
        .a-enter-vr { display: none !important; }
    </style>
</head>
<body>

    <div id="ui">
        <input type="file" id="fileInput" accept="video/*">
        <button id="startBtn" class="hidden">ENTER VR NOW</button>
        <p style="margin-top:15px; font-size:12px; opacity:0.6;">Ensure iPhone is in Landscape (Sideways)</p>
    </div>

    <a-scene id="scene" vr-mode-ui="enabled: false" style="display:none">
        <a-assets>
            <video id="v" crossorigin="anonymous" playsinline webkit-playsinline loop muted></video>
        </a-assets>

        <a-entity id="rig" position="0 0 0">
            <a-entity id="cam" camera="fov: 90" look-controls></a-entity>
        </a-entity>

        <a-videosphere id="leftSphere" src="#v" rotation="0 -90 0" 
                       material="repeat: 0.5 1; offset: 0 0" 
                       stereo="eye: left">
        </a-videosphere>

        <a-videosphere id="rightSphere" src="#v" rotation="0 -90 0" 
                       material="repeat: 0.5 1; offset: 0.5 0" 
                       stereo="eye: right">
        </a-videosphere>
    </a-scene>

    <script>
        // Critical Component for Eye Separation
        AFRAME.registerComponent('stereo', {
          schema: { eye: { default: 'left' } },
          init: function () {
            const layer = this.data.eye === 'left' ? 1 : 2;
            this.el.setAttribute('layers', layer);
            this.el.object3D.layers.set(layer);
          }
        });

        const fileInput = document.getElementById('fileInput');
        const startBtn = document.getElementById('startBtn');
        const video = document.getElementById('v');
        const scene = document.getElementById('scene');
        const ui = document.getElementById('ui');

        fileInput.onchange = (e) => {
            if (e.target.files[0]) {
                video.src = URL.createObjectURL(e.target.files[0]);
                video.load();
                startBtn.classList.remove('hidden');
            }
        };

        startBtn.onclick = async () => {
            // 1. Handle Permissions for Motion
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
            }

            // 2. Setup Video
            video.muted = false;
            ui.style.display = 'none';
            scene.style.display = 'block';
            
            // 3. Enter VR & Fullscreen
            video.play();
            
            // This is the "Dual Screen" trigger
            scene.enterVR();

            // Request browser fullscreen (hides URL bar)
            const doc = document.documentElement;
            if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
            else if (doc.requestFullscreen) doc.requestFullscreen();
        };
    </script>
</body>
</html>
