<!DOCTYPE html>
<html>
<head>
    <title>High-Perf Stereo 360</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style> 
        body { margin: 0; background: #000; color: white; font-family: sans-serif; }
        #ui { position: absolute; z-index: 1000; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        .box { margin: 10px; padding: 15px; background: #111; border: 1px solid #333; border-radius: 10px; width: 300px; text-align: center;}
        .btn { padding: 15px 40px; background: #ef2d5e; border: none; color: white; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 20px;}
    </style>
</head>
<body>

    <div id="ui">
        <h2>OPTIMIZED STEREO VR</h2>
        <div class="box">
            <label>LEFT EYE (and Audio)</label>
            <input type="file" id="leftFile" accept="video/*">
        </div>
        <div class="box">
            <label>RIGHT EYE (Visual Only)</label>
            <input type="file" id="rightFile" accept="video/*">
        </div>
        <button class="btn" id="startBtn">LAUNCH VR</button>
    </div>

    <a-scene renderer="antialias: false; precision: low; foveationLevel: 0;" vr-mode-ui="enabled: false">
        <a-assets>
            <video id="vL" loop crossorigin="anonymous" playsinline></video>
            <video id="vR" loop crossorigin="anonymous" playsinline muted></video>
        </a-assets>

        <a-videosphere id="sphereL" src="#vL" rotation="0 -90 0" visible="true"></a-videosphere>
        <a-videosphere id="sphereR" src="#vR" rotation="0 -90 0" visible="false"></a-videosphere>

        <a-camera id="mainCam" wasd-controls-enabled="false"></a-camera>
    </a-scene>

    <script>
        const btn = document.getElementById('startBtn');
        const vL = document.getElementById('vL');
        const vR = document.getElementById('vR');
        const scene = document.querySelector('a-scene');

        btn.onclick = () => {
            if (document.getElementById('leftFile').files[0] && document.getElementById('rightFile').files[0]) {
                vL.src = URL.createObjectURL(document.getElementById('leftFile').files[0]);
                vR.src = URL.createObjectURL(document.getElementById('rightFile').files[0]);
                
                document.getElementById('ui').style.display = 'none';
                vL.play();
                vR.play();
                scene.enterVR();

                // THE LOW-LOAD FIX: Manual Visibility Toggle
                // Instead of layers, we hide/show the spheres exactly when the eye renders
                const sL = document.getElementById('sphereL');
                const sR = document.getElementById('sphereR');

                scene.addEventListener('render-target-loaded', () => {
                   const renderer = scene.renderer;
                   renderer.setAnimationLoop(() => {
                       // If rendering left eye, show L and hide R
                       // This prevents the CPU from trying to calculate both at once
                       if (renderer.xr.isPresenting) {
                           const cameraL = renderer.xr.getCamera().cameras[0];
                           const cameraR = renderer.xr.getCamera().cameras[1];
                           
                           // We use the XR system's internal camera state to swap visibility
                           // This is much lighter than layer masks
                           sL.setAttribute('visible', 'true');
                           sR.setAttribute('visible', 'false');
                           renderer.render(scene.object3D, cameraL);

                           sL.setAttribute('visible', 'false');
                           sR.setAttribute('visible', 'true');
                           renderer.render(scene.object3D, cameraR);
                       }
                   });
                });
            }
        };
    </script>
</body>
</html>

