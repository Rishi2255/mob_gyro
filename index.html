<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>360 Stereo VR - Panolens</title>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; background: #000; }
        #container { width: 100%; height: 100%; }
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; background: #111; color: white; font-family: sans-serif;
        }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; background: #007bff; color: white; margin-top: 10px; }
        input { margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="ui">
    <h2>360 VR Video Player</h2>
    <p>Upload Top-Bottom (Over/Under) Video</p>
    <input type="file" id="fileInput" accept="video/*">
    <button id="startBtn" style="display:none">START VR MODE</button>
</div>

<div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r105/three.min.js"></script>
<script src="https://pchen66.github.io/js/panolens/panolens.min.js"></script>

<script>
    const fileInput = document.getElementById('fileInput');
    const startBtn = document.getElementById('startBtn');
    const ui = document.getElementById('ui');
    const container = document.getElementById('container');

    let viewer, videoPanorama;

    fileInput.onchange = (e) => {
        if (e.target.files[0]) {
            startBtn.style.display = 'block';
        }
    };

    async function initVR() {
        // 1. Request Gyro Permissions (Crucial for iOS)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try {
                await DeviceOrientationEvent.requestPermission();
            } catch (err) {
                console.error("Gyro permission denied");
            }
        }

        const file = fileInput.files[0];
        const url = URL.createObjectURL(file);

        // 2. Setup Viewer
        viewer = new PANOLENS.Viewer({ 
            container: container,
            controlBar: true,
            autoHideControlBar: true
        });

        // 3. Create Video Panorama in Stereo Top-Bottom mode
        // PANOLENS.VideoPanorama( url, options )
        videoPanorama = new PANOLENS.VideoPanorama(url, { 
            autoplay: true,
            muted: false,
            loop: true,
            playsinline: true
        });

        // This is the magic line that tells Panolens it's Top-Bottom
        videoPanorama.setStereoFormat(PANOLENS.Data.StereoFormat.TOP_BOTTOM);

        viewer.add(videoPanorama);

        // 4. Force Cardboard (Split Screen) Mode immediately
        viewer.enableControl(PANOLENS.Controls.DEVICEORIENTATION);
        viewer.enableEffect(PANOLENS.Modes.CARDBOARD);

        ui.style.display = 'none';
    }

    startBtn.addEventListener('click', initVR);
</script>
</body>
</html>
