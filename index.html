<!DOCTYPE html>
<html>
<head>
    <title>360 VR - SBS Fixed</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #ui { 
            position: absolute; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #000; color: white; font-family: sans-serif;
        }
        button { 
            padding: 20px 40px; background: #4A4A4A; color: white; border: none; 
            border-radius: 12px; font-size: 18px; cursor: pointer; margin-top: 10px;
        }
        .hidden { display: none !important; }
        .a-enter-vr, .a-enter-ar { display: none !important; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>VR 360 Player</h1>
        <input type="file" id="fileInput" accept="video/*">
        <button id="startBtn" class="hidden">START VIDEO</button>
    </div>

    <a-scene id="scene" vr-mode-ui="enabled: false" style="display:none">
        <a-assets>
            <video id="v" crossorigin="anonymous" playsinline webkit-playsinline loop muted></video>
        </a-assets>

        <a-entity id="rig">
            <a-entity camera="fov: 80" look-controls></a-entity>
        </a-entity>

        <a-videosphere id="leftSphere" src="#v" rotation="0 -90 0" 
                       material="repeat: 0.5 1; offset: 0 0" 
                       stereo="eye: left">
        </a-videosphere>

        <a-videosphere id="rightSphere" src="#v" rotation="0 -90 0" 
                       material="repeat: 0.5 1; offset: 0.5 0" 
                       stereo="eye: right">
        </a-videosphere>
    </a-scene>

    <script>
        // Custom Component to handle Eye separation
        AFRAME.registerComponent('stereo', {
          schema: { eye: { default: 'left' } },
          init: function () {
            this.el.setAttribute('layers', this.data.eye === 'left' ? 1 : 2);
            this.el.object3D.layers.set(this.data.eye === 'left' ? 1 : 2);
          }
        });

        const fileInput = document.getElementById('fileInput');
        const startBtn = document.getElementById('startBtn');
        const video = document.getElementById('v');
        const scene = document.getElementById('scene');
        const ui = document.getElementById('ui');

        fileInput.onchange = (e) => {
            if (e.target.files[0]) {
                const url = URL.createObjectURL(e.target.files[0]);
                video.src = url;
                video.load();
                startBtn.classList.remove('hidden');
            }
        };

        startBtn.onclick = async () => {
            // iOS Permission
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
            }

            // Unmute and Play
            video.muted = false;
            
            // Toggle UI
            ui.style.display = 'none';
            scene.style.display = 'block';
            
            video.play().then(() => {
                // Force Enter VR mode for dual screen
                setTimeout(() => {
                    scene.enterVR();
                }, 200);
            }).catch(err => {
                console.error("Video play failed:", err);
            });
            
            // Force Fullscreen
            const doc = document.documentElement;
            if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        };
    </script>
</body>
</html>
